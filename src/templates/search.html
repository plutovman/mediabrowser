{% extends "base.html" %}

{% block title %}Media Gallery{% endblock %}
{% block header_subtitle %}M E D I A   S E A R C H{% endblock %}

{% block extra_styles %}
:root {
    --col-checkbox: 20px;
    --col-media: 300px;
    --col-id: 150px;
    --col-subject: 120px;
    --col-genre: 120px;
    --col-setting: 120px;
    --col-captions: 300px;
    --col-tags: 300px;
    --col-filepath: 300px;
}

table {
    min-width: 1300px;
    table-layout: fixed;
}

{% endblock %}

{% block content %}
    <!-- Search Form -->
    <form class="search-form" method="GET" action="{{ url_for('page_search') }}">
        <input type="text" name="query" placeholder="Search genre, category, subject, tags..." value="{{ search_query }}">
        <select name="db_table" onchange="this.form.submit();">
            {% for table in db_tables %}
            <option value="{{ table }}" {% if db_table == table %}selected{% endif %}>{{ table }}</option>
            {% endfor %}
        </select>
        <select name="file_type">
            <option value="">All File Types</option>
            {% for ft in file_types %}
            <option value="{{ ft }}" {% if file_type_filter == ft %}selected{% endif %}>{{ ft }}</option>
            {% endfor %}
        </select>
        <select name="genre">
            <option value="">All Genres</option>
            {% for g in genres %}
            <option value="{{ g }}" {% if genre_filter == g %}selected{% endif %}>{{ g }}</option>
            {% endfor %}
        </select>
        <button type="submit">Search</button>
    </form>

    <!-- Add a "Clear Search" link if a query is active -->
    {% if search_query or file_type_filter or genre_filter %}
    <div style="text-align: center; margin: 10px 0;">
        <a href="{{ url_for('page_search', db_table=db_table) }}">Clear Search</a>
    </div>
    {% endif %}

    <!-- View mode selector -->
    <div style="text-align: center; margin: 20px 0;">
        <label>View Mode:</label>
        <a href="{{ url_for('page_search', query=search_query, file_type=file_type_filter, genre=genre_filter, db_table=db_table, page=1, view='table') }}" style="margin: 0 10px;">Table</a>
        <a href="{{ url_for('page_search', query=search_query, file_type=file_type_filter, genre=genre_filter, db_table=db_table, page=1, view='grid') }}" style="margin: 0 10px; font-weight: bold;">Grid</a>
    </div>

    <p style="text-align: center;">{{ page }} of {{ total_pages }} (Total Records Found: {{ total_media_count }})</p>

    <!-- Pagination Controls -->
    <div class="pagination">
        {% if page > 1 %}
            <a href="{{ url_for('page_search', page=page - 1, query=search_query, file_type=file_type_filter, genre=genre_filter, db_table=db_table, view=view) }}">Previous</a>
        {% else %}
            <span class="disabled">Previous</span>
        {% endif %}

        {% if page < total_pages %}
            <a href="{{ url_for('page_search', page=page + 1, query=search_query, file_type=file_type_filter, genre=genre_filter, db_table=db_table, view=view) }}">Next</a>
        {% else %}
            <span class="disabled">Next</span>
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('page_search') }}">
        {% if view == 'table' %}
        <table>
            <thead>
                <tr>
                    <th style="width: var(--col-checkbox);"><button type="button" id="toggleAll" style="padding: 5px 5px; cursor: pointer;">&#10003;</button></th>
                    <th style="width: var(--col-media);">Media</th>
                    <th style="width: var(--col-id);">ID</th>
                    <th style="width: var(--col-subject);">Subject</th>
                    <th style="width: var(--col-genre);">Genre</th>
                    <th style="width: var(--col-setting);">Setting</th>
                    <th style="width: var(--col-captions);">Captions</th>
                    <th style="width: var(--col-tags);">Tags</th>
                    <th style="width: var(--col-filepath);">File Path</th>
                </tr>
            </thead>
            <tbody>
                <!-- Jinja loop to iterate over the 'media' data passed from app.py -->
                {% for media_item in media %}
                <tr>
                    <td style="text-align: center;"><input type="checkbox" name="selected" value="{{ media_item['file_id'] }}"></td>
                    <td style="text-align: center; width: var(--col-media);">
                        <div class="media-card">
                            {% if media_item['ext_is_viewable'] %}
                            {% if media_item['file_type'] == 'mp4' %}
                            <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                                 alt="{{ media_item['file_name'] }}"
                                 class="thumbnail"
                                 data-open-video="{{ url_for('static', filename=media_item['relative_path']) }}"
                                 data-poster="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">
                            <button type="button" class="play-button"
                                    data-open-video="{{ url_for('static', filename=media_item['relative_path']) }}"
                                    data-poster="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">▶</button>
                            {% else %}
                            <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                                 alt="{{ media_item['file_name'] }}"
                                 class="thumbnail"
                                 data-open-image="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">
                            {% endif %}
                            {% else %}
                            <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                                 alt="{{ media_item['file_name'] }}"
                                 class="thumbnail"
                                 style="cursor: pointer;"
                                 data-download-file="{{ url_for('static', filename=media_item['relative_path']) }}"
                                 data-download-name="{{ media_item['file_name'] }}">
                            {% endif %}
                        </div>
                        <p style="text-align: center; margin: 5px 0 0 0; font-size: 12px; word-break: break-all;">{{ media_item['file_name'] }}</p>
                    </td>
                    <!--specify width for each td -->
                    <td style="width: var(--col-id);">{{ media_item['file_id'] }}</td>
                    <td style="width: var(--col-subject);">{{ media_item['subject'] }}</td>
                    <td style="width: var(--col-genre);">{{ media_item['genre'] }}</td>
                    <td style="width: var(--col-setting);">{{ media_item['setting'] }}</td>
                    <td style="width: var(--col-captions);">{{ media_item['captions'] }}</td>
                    <td style="width: var(--col-tags);">{{ media_item['tags'] }}</td>
                    <td style="width: var(--col-filepath);">{{ media_item['file_path'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% elif view == 'grid' %}
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 900px; margin: 0 auto;">
            {% for media_item in media %}
            <div style="position: relative; border: 1px solid #555; padding: 10px; background-color: #333; display: flex; flex-direction: column; align-items: center; min-height: 200px;">
                <input type="checkbox" name="selected" value="{{ media_item['file_id'] }}" style="position: absolute; top: 5px; left: 5px; z-index: 10;">
                 <div class="media-card" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                    {% if media_item['ext_is_viewable'] %}
                    {% if media_item['file_type'] == 'mp4' %}
                    <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                        alt="{{ media_item['file_name'] }}"
                        style="max-width: 100%; height: auto; display: block;" class="thumbnail"
                        data-open-video="{{ url_for('static', filename=media_item['relative_path']) }}"
                        data-poster="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">
                    <button type="button" class="play-button"
                           data-open-video="{{ url_for('static', filename=media_item['relative_path']) }}"
                           data-poster="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">▶</button>
                    {% else %}
                    <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                        alt="{{ media_item['file_name'] }}"
                        style="max-width: 100%; height: auto; display: block;" class="thumbnail"
                        data-open-image="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">
                    {% endif %}
                    {% else %}
                    <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                        alt="{{ media_item['file_name'] }}"
                        style="max-width: 100%; height: auto; display: block; cursor: pointer;" class="thumbnail"
                        data-download-file="{{ url_for('static', filename=media_item['relative_path']) }}"
                        data-download-name="{{ media_item['file_name'] }}">
                    {% endif %}
                 </div>
                 <p style="text-align: center; margin: 5px 0 0 0; font-size: 12px; word-break: break-all; width: 100%;">{{ media_item['file_name'] }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <input type="hidden" name="query" value="{{ search_query }}">
        <input type="hidden" name="file_type" value="{{ file_type_filter }}">
        <input type="hidden" name="genre" value="{{ genre_filter }}">
        <input type="hidden" name="db_table" value="{{ db_table }}">
        <input type="hidden" name="page" value="{{ page }}">
        <input type="hidden" name="view" value="{{ view }}">
        <div style="text-align: center; margin-top: 20px;">
            <button type="submit">Add To Cart</button>
        </div>
    </form>

    <!-- Pagination Controls -->
    <div class="pagination">
        {% if page > 1 %}
            <a href="{{ url_for('page_search', page=page - 1, query=search_query, file_type=file_type_filter, genre=genre_filter, db_table=db_table, view=view) }}">Previous</a>
        {% else %}
            <span class="disabled">Previous</span>
        {% endif %}

        {% if page < total_pages %}
            <a href="{{ url_for('page_search', page=page + 1, query=search_query, file_type=file_type_filter, genre=genre_filter, db_table=db_table, view=view) }}">Next</a>
        {% else %}
            <span class="disabled">Next</span>
        {% endif %}
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        const checkboxes = document.querySelectorAll('input[name="selected"]');
        const button = document.querySelector('form[method="POST"] button[type="submit"]');

        function updateButton() {
            const checked = Array.from(checkboxes).some(cb => cb.checked);
            button.disabled = !checked;
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updateButton));
        updateButton();

        // Toggle all checkboxes
        const toggleAllBtn = document.getElementById('toggleAll');
        if (toggleAllBtn) {
            toggleAllBtn.addEventListener('click', function() {
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
                updateButton();
            });
        }
    </script>
{% endblock %}