{% extends "base.html" %}

{% block title %}PRODUCTION{% endblock %}

{% block extra_styles %}
.dropdown-container {
    text-align: center;
    margin: 30px 0;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.dropdown-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.dropdown-group label {
    color: #f0f0f0;
    font-size: 14px;
    font-weight: bold;
}

.dropdown-group select {
    padding: 10px 15px;
    font-size: 14px;
    border: 1px solid #555;
    background-color: #333;
    color: #f0f0f0;
    border-radius: 4px;
    min-width: 200px;
    cursor: pointer;
}

.dropdown-group select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.dropdown-group select:hover:not(:disabled) {
    border-color: #777;
    background-color: #3a3a3a;
}

/* Multilevel Dropdown Menu Styles */
.dropdown-container {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.nav-menu-container {
    display: inline-block;
    position: relative;
}

#nav-menu {
    list-style: none;
    padding: 0;
    margin: 0;
    background-color: #333;
    border: 1px solid #555;
    border-radius: 4px;
    display: flex;
    flex-direction: row;
    gap: 0;
}

#nav-menu > li {
    position: relative;
    border-right: 1px solid #444;
}

#nav-menu > li:last-child {
    border-right: none;
}

#nav-menu > li > a {
    display: block;
    padding: 12px 20px;
    color: #f0f0f0;
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.2s;
    white-space: nowrap;
}

#nav-menu > li > a:hover {
    background-color: #3a3a3a;
}

#nav-menu li.has-submenu > a::after {
    content: '▼';
    margin-left: 8px;
    font-size: 10px;
}

/* Submenu styles */
#nav-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
    position: absolute;
    left: 0;
    top: 100%;
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 4px;
    min-width: 150px;
    display: none;
    z-index: 1000;
    text-align: left;
}

/* Year menu - narrow width for 4-digit years, positioned below JOB SELECT, right-aligned */
#years-menu {
    min-width: 100px !important;
    left: auto !important;
    right: 0 !important;
    top: 100% !important;
}

/* Nested submenus (projects, apps, subdirs) */
#nav-menu ul ul {
    left: 100%;
    top: 0;
    min-width: 150px;
}

#nav-menu li:hover > ul {
    display: block;
}

/* Force all menus closed when this class is applied */
.menus-closed #nav-menu ul {
    display: none !important;
}

#nav-menu ul li {
    position: relative;
    border-bottom: 1px solid #333;
}

#nav-menu ul li:last-child {
    border-bottom: none;
}

#nav-menu ul li a {
    display: block;
    padding: 10px 15px;
    font-size: 13px;
    color: #f0f0f0;
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.2s;
    text-align: left;
}

#nav-menu ul li a:hover {
    background-color: #3a3a3a;
}

#nav-menu ul li.has-submenu > a::after {
    content: '▶';
    float: right;
    font-size: 10px;
}

.nav-placeholder {
    padding: 12px 20px;
    color: #888;
    font-style: italic;
    text-align: center;
}

.open-button {
    padding: 10px 30px;
    font-size: 16px;
    background-color: #4a9eff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.2s;
}

.open-button:disabled {
    background-color: #555;
    color: #888;
    cursor: not-allowed;
    opacity: 0.5;
}

.open-button:hover:not(:disabled) {
    background-color: #3a8eef;
}

.status-message {
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    border-radius: 4px;
    display: none;
}

.status-success {
    background-color: #4CAF50;
    color: white;
}

.status-error {
    background-color: #f44336;
    color: white;
}

.info-display {
    text-align: center;
    margin: 30px auto;
    max-width: 800px;
    padding: 20px;
    background-color: #2a2a2a;
    border-radius: 8px;
    color: #b0b0b0;
}

.info-display .path-display {
    font-family: monospace;
    background-color: #1a1a1a;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    word-break: break-all;
    color: #4CAF50;
}
{% endblock %}

{% block content %}

    <!-- <div style="text-align: center; margin-top: 30px;">
        <h1 style="color: #ffffff; font-size: 48px;">PRODUCTION</h1>
        <p style="color: #b0b0b0; font-size: 18px; margin-top: 10px;">
            Using database: {{ db_table }}
        </p>
    </div> -->

    <!-- Navigation Menu -->
    <div class="dropdown-container">
        <div class="nav-menu-container horizontal-menu">
            <ul id="nav-menu" class="horizontal-nav">
                <li id="project-select-root" class="has-submenu">
                    <a>JOB SELECT</a>
                    <ul id="years-menu" class="year-submenu">
                        <!-- Years will be populated here -->
                    </ul>
                </li>
                <li class="nav-button">
                    <a onclick="newProject()">NEW JOB</a>
                </li>
                <li class="nav-button">
                    <a onclick="research()">RESEARCH</a>
                </li>
                <li class="nav-button">
                    <a onclick="archive()">ARCHIVE</a>
                </li>
            </ul>
        </div>
    </div>


    <!-- Job Dashboard -->
    <div id="info-display" class="info-display" style="display: none; max-width: 900px; margin: 20px auto;">
        <h3 style="color: #4a9eff; margin-bottom: 20px; text-align: center;">Job Dashboard</h3>
        
        <!-- Info Display Section (for openDirectory feedback) -->
        <div style="margin-bottom: 20px; padding: 15px; background-color: #1a1a1a; border-radius: 4px;">
            <div>
                <strong style="color: #aaa;">Opening Browser To:</strong>
                <span id="info-feedback" style="color: #4CAF50; margin-left: 10px; font-family: monospace;">-</span>
            </div>
            <!-- Hidden elements for JS compatibility -->
            <span id="info-project" style="display: none;"></span>
            <span id="info-app" style="display: none;"></span>
        </div>
        
        <form id="jobForm">
            <!-- Row 1: Job Name, Job Alias, Job State, Job Year -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Job Name</label>
                    <input type="text" id="job_name" name="job_name" readonly>
                </div>
                <div class="form-group">
                    <label>Job Alias</label>
                    <input type="text" id="job_alias" name="job_alias" readonly>
                </div>
                <div class="form-group">
                    <label>Job State</label>
                    <input type="text" id="job_state" name="job_state" readonly>
                </div>
                <div class="form-group">
                    <label>Job Year</label>
                    <input type="text" id="job_year" name="job_year" readonly>
                </div>
            </div>
            
            <!-- Row 2: Job User ID, Job User Name, Job Date Created -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Created: userId</label>
                    <input type="text" id="job_user_id" name="job_user_id" readonly>
                </div>
                <div class="form-group">
                    <label>Created: userName</label>
                    <input type="text" id="job_user_name" name="job_user_name" readonly>
                </div>
                <div class="form-group">
                    <label>Created Date</label>
                    <input type="text" id="job_date_created" name="job_date_created" readonly>
                </div>
            </div>
            
            <!-- Row 3: Edit User ID, Edit User Name, Edit Date -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Edited: userId</label>
                    <input type="text" id="job_edit_user_id" name="job_edit_user_id" readonly>
                </div>
                <div class="form-group">
                    <label>Edited: userName</label>
                    <input type="text" id="job_edit_user_name" name="job_edit_user_name" readonly>
                </div>
                <div class="form-group">
                    <label>Edited: Date</label>
                    <input type="text" id="job_edit_date" name="job_edit_date" readonly>
                </div>
            </div>
            
            <!-- Row 4: Paths -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Job Path</label>
                    <input type="text" id="job_path_job" name="job_path_job" readonly>
                </div>
                <div class="form-group">
                    <label>R&D Path</label>
                    <input type="text" id="job_path_rnd" name="job_path_rnd" readonly>
                </div>
            </div>
            
            <!-- Row 5: Charges and Date Due -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Job Charge 1</label>
                    <input type="text" id="job_charge1" name="job_charge1">
                </div>
                <div class="form-group">
                    <label>Job Charge 2</label>
                    <input type="text" id="job_charge2" name="job_charge2">
                </div>
                <div class="form-group">
                    <label>Job Charge 3</label>
                    <input type="text" id="job_charge3" name="job_charge3">
                </div>
                <div class="form-group">
                    <label>Date Due</label>
                    <input type="text" id="job_date_due" name="job_date_due">
                </div>
            </div>

            <!-- Row 6: Notes -->
            <div class="form-group">
                <label>Job Notes</label>
                <textarea id="job_notes" name="job_notes" rows="4" style="min-height: 80px;"></textarea>
            </div>
            
            <!-- Row 7: Tags -->
            <div class="form-group">
                <label>Job Tags</label>
                <input type="text" id="job_tags" name="job_tags">
            </div>
            
        </form>
    </div>

    <!-- Action Buttons -->
    <div id="action-buttons" style="display: none; gap: 15px; margin-top: 20px; justify-content: center;">
        <button type="button" id="buttonEdit" class="btn-primary" onclick="jobEditOrSave()" style="padding: 10px 30px;">
            Edit Job
        </button>
        <button type="button" id="buttonCancel" class="btn-secondary" onclick="jobEditCancel()" style="padding: 10px 30px; background-color: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Cancel
        </button>
    </div>

    <!-- New Job Dashboard -->
    <div id="new-job-display" class="info-display" style="display: none; max-width: 600px; margin: 20px auto;">
        <h3 style="color: #4a9eff; margin-bottom: 20px; text-align: center;">New Job Name</h3>
        
        <form id="newJobForm">
            <!-- Job Base -->
            <div class="form-group">
                <label>Job Base <span style="color: #aaa; font-size: 0.9em;"></span></label>
                <input type="text" id="new_job_base" name="job_base" placeholder="lowercase letters, numbers, underscores only" oninput="validateJobBase()">
            </div>

            <!-- Validation Feedback -->
            <div id="validation-feedback" style="display: none; margin-top: 15px; margin-bottom: 15px; padding: 10px; background-color: #4a1a1a; border-left: 4px solid #ff4444; border-radius: 4px;">
                <span id="validation-feedback-text" style="color: #ff6666;">Only lowercase letters, numbers, and underscores allowed</span>
            </div>
            
            <!-- Job Name  -->
            <div class="form-group">
                <label>Job Name <span style="color: #aaa; font-size: 0.9em;"></span></label>
                <input type="text" id="new_job_name" name="job_name" readonly>
            </div>
            
            <!-- Job Alias  -->
            <div class="form-group">
                <label>Job Alias <span style="color: #aaa; font-size: 0.9em;"></span></label>
                <input type="text" id="new_job_alias" name="job_alias" readonly>
            </div>
            
            <!-- Job Path  -->
            <div class="form-group">
                <label>Job Path <span style="color: #aaa; font-size: 0.9em;"></span></label>
                <input type="text" id="new_job_path" name="job_path" readonly>
            </div>
            
        </form>
        
        <!-- Action Buttons for New Job -->
        <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
            <button type="button" id="btn-create-job" class="btn-primary" onclick="createNewJob()" style="padding: 10px 30px;">
                Create Job
            </button>
            <button type="button" class="btn-secondary" onclick="cancelNewJob()" style="padding: 10px 30px; background-color: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Cancel
            </button>
        </div>
    </div>

    <script>
        let years = {{ years|tojson }};
        let menuBuilt = false;

        // Build years menu on first hover of JOB SELECT button
        document.getElementById('project-select-root').addEventListener('mouseenter', async function() {
            if (menuBuilt) return;
            menuBuilt = true;
            
            const yearsMenu = document.getElementById('years-menu');
            yearsMenu.innerHTML = '<li class="nav-placeholder">Loading...</li>';
            
            try {
                yearsMenu.innerHTML = '';
                
                for (const year of years) {
                    const yearLi = document.createElement('li');
                    yearLi.className = 'has-submenu';
                    
                    const yearA = document.createElement('a');
                    yearA.textContent = year;
                    yearLi.appendChild(yearA);
                    
                    // Lazy load projects when year is hovered
                    yearLi.addEventListener('mouseenter', async function() {
                        if (this.dataset.loaded) return;
                        this.dataset.loaded = 'true';
                        
                        const projectsResponse = await fetch(`/api/projects_by_year?year=${encodeURIComponent(year)}`);
                        const projectsData = await projectsResponse.json();
                        
                        if (projectsData.projects && projectsData.projects.length > 0) {
                            const projectsUl = document.createElement('ul');
                            
                            for (const project of projectsData.projects) {
                                const projectLi = document.createElement('li');
                                projectLi.className = 'has-submenu';
                                
                                const projectA = document.createElement('a');
                                projectA.textContent = project.name;
                                projectA.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    // Populate project selection info with DB data
                                    fetch('/api/action_jobactive_dashboard_populate', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ job_name: project.name, job_path_job: project.path })
                                    })
                                    .then(async (r) => {
                                        const text = await r.text();
                                        let data;
                                        try {
                                            data = text ? JSON.parse(text) : {};
                                        } catch (err) {
                                            document.getElementById('info-feedback').textContent = 'Error parsing response: ' + text;
                                            document.getElementById('info-display').style.display = 'block';
                                            return;
                                        }

                                        if (!r.ok) {
                                            document.getElementById('info-feedback').textContent = 'Error: ' + (data.message || r.statusText || 'Request failed');
                                            document.getElementById('info-display').style.display = 'block';
                                            return;
                                        }

                                        if (!data.success) {
                                            document.getElementById('info-feedback').textContent = 'Error: ' + (data.message || 'Unknown');
                                            document.getElementById('info-display').style.display = 'block';
                                            return;
                                        }

                                        const job = data.job || {};
                                        document.getElementById('info-project').textContent = job.job_name || project.name;
                                        document.getElementById('info-app').textContent = '-';
                                        document.getElementById('info-feedback').textContent = job.job_path_job || project.path || '-';

                                        // Populate job dashboard form
                                        populateJobForm(job);
                                        document.getElementById('info-display').style.display = 'block';
                                    })
                                    .catch(err => {
                                        document.getElementById('info-feedback').textContent = 'Error: ' + err.message;
                                        document.getElementById('info-display').style.display = 'block';
                                    });
                                });
                                projectLi.appendChild(projectA);
                                
                                // Lazy load apps when project is hovered
                                projectLi.addEventListener('mouseenter', async function() {
                                    if (this.dataset.loaded) return;
                                    this.dataset.loaded = 'true';
                                    
                                    const appsResponse = await fetch(`/api/apps_by_project?project=${encodeURIComponent(project.name)}`);
                                    const appsData = await appsResponse.json();
                                    
                                    if (appsData.apps && appsData.apps.length > 0) {
                                        const appsUl = document.createElement('ul');
                                        
                                        for (const app of appsData.apps) {
                                            const subdirsResponse = await fetch(`/api/subdirs_by_app?app=${encodeURIComponent(app)}`);
                                            const subdirsData = await subdirsResponse.json();
                                            
                                            const appLi = document.createElement('li');
                                            
                                            if (subdirsData.subdirs && subdirsData.subdirs.length > 0) {
                                                appLi.className = 'has-submenu';
                                                const appA = document.createElement('a');
                                                appA.textContent = app;
                                                appA.addEventListener('click', (e) => {
                                                    e.stopPropagation();
                                                    openDirectory(appsData.job_path_job, project.name, app, null);
                                                });
                                                appLi.appendChild(appA);
                                                
                                                const subdirsUl = document.createElement('ul');
                                                subdirsData.subdirs.forEach(subdir => {
                                                    const subdirLi = document.createElement('li');
                                                    const subdirA = document.createElement('a');
                                                    subdirA.textContent = subdir;
                                                    subdirA.addEventListener('click', (e) => {
                                                        e.stopPropagation();
                                                        openDirectory(appsData.job_path_job, project.name, app, subdir);
                                                    });
                                                    subdirLi.appendChild(subdirA);
                                                    subdirsUl.appendChild(subdirLi);
                                                });
                                                appLi.appendChild(subdirsUl);
                                            } else {
                                                const appA = document.createElement('a');
                                                appA.textContent = app;
                                                appA.addEventListener('click', () => {
                                                    openDirectory(appsData.job_path_job, project.name, app, null);
                                                });
                                                appLi.appendChild(appA);
                                            }
                                            
                                            appsUl.appendChild(appLi);
                                        }
                                        
                                        this.appendChild(appsUl);
                                    }
                                }, { once: true });
                                
                                projectsUl.appendChild(projectLi);
                            }
                            
                            this.appendChild(projectsUl);
                        }
                    }, { once: true });
                    
                    yearsMenu.appendChild(yearLi);
                }
            } catch (error) {
                yearsMenu.innerHTML = '<li class="nav-placeholder">Error loading menu</li>';
                showStatus('Error building navigation menu: ' + error.message, 'error');
            }
        }, { once: true });

        function openDirectory(jobPath, projectName, app, subdir) {
            // Close all menus immediately
            closeAllMenus();
            
            if (!jobPath || (!app && projectName)) {
                // Opening project level directory
                document.getElementById('info-project').textContent = projectName;
                document.getElementById('info-app').textContent = '-';
                document.getElementById('info-feedback').textContent = jobPath;
                document.getElementById('info-display').style.display = 'block';
                
                // Call API to open project directory
                fetch('/api/open_app_directory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        job_path_job: jobPath,
                        app: null,
                        subdir: null
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        document.getElementById('info-feedback').textContent = 'Error: ' + data.message;
                    }
                })
                .catch(error => {
                    document.getElementById('info-feedback').textContent = 'Error: ' + error.message;
                });
                return;
            }
            
            if (!jobPath || !app) {
                document.getElementById('info-feedback').textContent = 'Error: Cannot open directory - missing path information';
                document.getElementById('info-display').style.display = 'block';
                return;
            }
            
            // Build path with unexpanded environment variable for compact display
            const displayPath = subdir ? `${jobPath}/${app}/${subdir}` : `${jobPath}/${app}`;
            
            // Update info display
            document.getElementById('info-project').textContent = projectName;
            document.getElementById('info-app').textContent = subdir ? `${app}/${subdir}` : app;
            document.getElementById('info-feedback').textContent = displayPath;
            document.getElementById('info-display').style.display = 'block';
            
            // Call API to open directory immediately
            fetch('/api/open_app_directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    job_path_job: jobPath,
                    app: app,
                    subdir: subdir || null
                })
            })
            .then(response => response.json())
            .then(data => {
                // Optionally update feedback with success/error, or keep showing path
                if (!data.success) {
                    document.getElementById('info-feedback').textContent = 'Error: ' + data.message;
                }
            })
            .catch(error => {
                document.getElementById('info-feedback').textContent = 'Error: ' + error.message;
            });
        }

        function closeAllMenus() {
            // Add class to nav container to force all menus closed
            const navContainer = document.querySelector('.nav-menu-container');
            navContainer.classList.add('menus-closed');
            
            // Remove the class after a short delay so menus can be opened again on next hover
            setTimeout(() => {
                navContainer.classList.remove('menus-closed');
            }, 300);
        }

        function showStatus(message, type) {
            const feedbackDiv = document.getElementById('info-feedback');
            feedbackDiv.textContent = message;
            document.getElementById('info-display').style.display = 'block';
        }
        
        function newProject() {
            // Hide existing job dashboard
            document.getElementById('info-display').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'none';
            
            // Clear and show new job dashboard
            document.getElementById('new_job_base').value = '';
            document.getElementById('new_job_name').value = '';
            document.getElementById('new_job_alias').value = '';
            document.getElementById('new_job_path').value = '';
            document.getElementById('validation-feedback').style.display = 'none';
            document.getElementById('new-job-display').style.display = 'block';
            
            // Reset field colors
            document.getElementById('new_job_name').style.color = '#f0f0f0';
            document.getElementById('new_job_alias').style.color = '#f0f0f0';
            
            // Close all menus
            closeAllMenus();
        }
        
        function research() {
            window.open('/search', '_blank');
        }
        
        function archive() {
            window.open('/archive', '_blank');
        }
        
        // Populate job dashboard form with job data
        // Constants for button states
        const jobContextEdit = 'Edit Job Info';
        const jobContextSave = 'Save Job Info';
        
        // List of editable fields (matching list_columns_editable in backend)
        const editableFields = ['job_date_due', 'job_charge1', 'job_charge2', 'job_charge3', 'job_tags', 'job_notes'];
        
        // Store original job data for cancel/restore functionality
        let originalJobData = null;
        
        function populateJobForm(job) {
            // Store original job data for cancel functionality
            originalJobData = JSON.parse(JSON.stringify(job)); // Deep copy
            
            document.getElementById('job_name').value = job.job_name || '';
            document.getElementById('job_alias').value = job.job_alias || '';
            document.getElementById('job_state').value = job.job_state || '';
            document.getElementById('job_year').value = job.job_year || '';
            document.getElementById('job_user_id').value = job.job_user_id || '';
            document.getElementById('job_user_name').value = job.job_user_name || '';
            document.getElementById('job_date_created').value = job.job_date_created || '';
            document.getElementById('job_edit_user_id').value = job.job_edit_user_id || '';
            document.getElementById('job_edit_user_name').value = job.job_edit_user_name || '';
            document.getElementById('job_edit_date').value = job.job_edit_date || '';
            document.getElementById('job_date_created').value = job.job_date_created || '';
            document.getElementById('job_date_due').value = job.job_date_due || '';
            document.getElementById('job_charge1').value = job.job_charge1 || '';
            document.getElementById('job_charge2').value = job.job_charge2 || '';
            document.getElementById('job_charge3').value = job.job_charge3 || '';
            document.getElementById('job_path_job').value = job.job_path_job || '';
            document.getElementById('job_path_rnd').value = job.job_path_rnd || '';
            document.getElementById('job_tags').value = job.job_tags || '';
            document.getElementById('job_notes').value = job.job_notes || '';
            
            // Disable all editable fields initially
            editableFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.disabled = true;
            });
            
            // Reset button to "Edit Job" mode
            const editButton = document.querySelector('button[onclick="jobEditOrSave()"]');
            if (editButton) {
                editButton.textContent = jobContextEdit;
                editButton.dataset.mode = 'edit';
            }
            
            // Show action buttons when job is loaded
            document.getElementById('action-buttons').style.display = 'flex';
        }
        
        // Toggle between Edit and Save modes
        async function jobEditOrSave() {
            const editButton = document.querySelector('button[onclick="jobEditOrSave()"]');
            const mode = editButton.dataset.mode || 'edit';
            
            if (mode === 'edit') {
                // Switch to edit mode: enable editable fields
                editableFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.disabled = false;
                });
                
                // Change button to "Save Job"
                editButton.textContent = jobContextSave;
                editButton.dataset.mode = 'save';
                
            } else {
                // Save mode: send data to backend
                const formData = {
                    job_name: document.getElementById('job_name').value
                };
                
                // Only include editable fields in the update
                editableFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        formData[fieldId] = field.value || '';
                    }
                });
                
                try {
                    const response = await fetch('/api/action_jobactive_dashboard_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showStatus('Job data saved successfully', 'success');
                        
                        // Disable fields again and switch back to edit mode
                        editableFields.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (field) field.disabled = true;
                        });
                        
                        editButton.textContent = jobContextEdit;
                        editButton.dataset.mode = 'edit';
                    } else {
                        showStatus('Error saving job data: ' + (data.message || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showStatus('Error saving job data: ' + error.message, 'error');
                }
            }
        }
        
        // New Job
        function jobEditNew() {
            document.getElementById('info-display').style.display = 'none';
            // Optionally reload original data
        }
        
        // Cancel job edit
        function jobEditCancel() {
            const editButton = document.querySelector('button[onclick="jobEditOrSave()"]');
            const mode = editButton.dataset.mode || 'edit';
            
            // If in edit mode (fields are enabled), reload original data and disable fields
            if (mode === 'save') {
                // Restore original data if available
                if (originalJobData) {
                    populateJobForm(originalJobData);
                } else {
                    // Just disable fields if no original data stored
                    editableFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) field.disabled = true;
                    });
                    
                    // Switch button back to "Edit Job" mode
                    editButton.textContent = jobContextEdit;
                    editButton.dataset.mode = 'edit';
                }
            } else {
                // Not in edit mode, just hide the dashboard and buttons
                document.getElementById('info-display').style.display = 'none';
                document.getElementById('action-buttons').style.display = 'none';
            }
        }
        
        // Validate job base as user types
        async function validateJobBase() {
            const jobBase = document.getElementById('new_job_base').value;
            const jobNameField = document.getElementById('new_job_name');
            const jobAliasField = document.getElementById('new_job_alias');
            const jobPathField = document.getElementById('new_job_path');
            const feedbackDiv = document.getElementById('validation-feedback');
            const createButton = document.getElementById('btn-create-job');
            
            // Clear fields if job_base is empty
            if (!jobBase) {
                jobNameField.value = '';
                jobAliasField.value = '';
                jobPathField.value = '';
                jobNameField.style.color = '#f0f0f0';
                jobAliasField.style.color = '#f0f0f0';
                feedbackDiv.style.display = 'none';
                createButton.disabled = true;
                return;
            }
            
            try {
                // Call backend API to validate and generate job name/alias
                const response = await fetch('/api/job_name_validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_base: jobBase })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    // Valid input - show generated values in normal color
                    jobNameField.value = data.job_name || '';
                    jobAliasField.value = data.job_alias || '';
                    jobPathField.value = data.job_path || '';
                    jobNameField.style.color = '#4CAF50';
                    jobAliasField.style.color = '#4CAF50';
                    feedbackDiv.style.display = 'none';
                    createButton.disabled = false;
                } else {
                    // Invalid input - show error feedback with specific reason
                    jobNameField.value = '';
                    jobAliasField.value = '';
                    jobPathField.value = '';
                    jobNameField.style.color = '#ff4444';
                    jobAliasField.style.color = '#ff4444';
                    createButton.disabled = true;
                    
                    // Update feedback message with specific validation reason
                    const feedbackText = document.getElementById('validation-feedback-text');
                    if (feedbackText && data.reason) {
                        feedbackText.textContent = data.reason;
                    }
                    feedbackDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error validating job base:', error);
            }
        }
        
        // Create new job
        async function createNewJob() {
            const jobBase = document.getElementById('new_job_base').value;
            const jobName = document.getElementById('new_job_name').value;
            const jobAlias = document.getElementById('new_job_alias').value;
            
            if (!jobBase || !jobName || !jobAlias) {
                showStatus('Please enter a valid job base', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/job_new_create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        job_base: jobBase,
                        job_name: jobName,
                        job_alias: jobAlias
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('Job created successfully: ' + data.job_name, 'success');
                    cancelNewJob();
                    
                    // Load the new job into the Job Dashboard and enter edit mode
                    if (data.job_data) {
                        // Show the job dashboard with the new job data
                        document.getElementById('info-display').style.display = 'block';
                        populateJobForm(data.job_data);
                        
                        // Automatically enter edit mode
                        const editButton = document.querySelector('button[onclick="jobEditOrSave()"]');
                        if (editButton && editButton.dataset.mode === 'edit') {
                            // Trigger edit mode by simulating the button click logic
                            editableFields.forEach(fieldId => {
                                const field = document.getElementById(fieldId);
                                if (field) field.disabled = false;
                            });
                            editButton.textContent = jobContextSave;
                            editButton.dataset.mode = 'save';
                        }
                    }
                } else {
                    showStatus('Error creating job: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('Error creating job: ' + error.message, 'error');
            }
        }
        
        // Cancel new job creation
        function cancelNewJob() {
            document.getElementById('new-job-display').style.display = 'none';
            document.getElementById('new_job_base').value = '';
            document.getElementById('new_job_name').value = '';
            document.getElementById('new_job_alias').value = '';
            document.getElementById('new_job_path').value = '';
        }
    </script>

{% endblock %}
