{% extends "base.html" %}
{% block title %}Project Central{% endblock %}
{% block header_subtitle %}P R O J E C T  M A N A G E M E N T{% endblock %}


{% block extra_styles %}
:root {
    /* Menu width variables */
    --menu-width-standard: 150px;
    --menu-width-years: 100px;
    --menu-width-sync-item: 180px;
    --menu-width-sync-container: 200px;
    
    /* Color variables */
    --color-background: #242424;
    --color-background-light: #2a2a2a;
    --color-background-lighter: #333;
    --color-background-hover: #3a3a3a;
    --color-text: #f0f0f0;
    --color-border: #555;
    --color-border-light: #777;
}

.dropdown-container {
    text-align: center;
    margin: 30px 0;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.dropdown-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.dropdown-group label {
    color: #f0f0f0;
    font-size: 14px;
    font-weight: bold;
}

.dropdown-group select {
    padding: 10px 15px;
    font-size: 14px;
    border: 1px solid #555;
    background-color: #333;
    color: #f0f0f0;
    border-radius: 4px;
    min-width: 200px;
    cursor: pointer;
}

.dropdown-group select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.dropdown-group select:hover:not(:disabled) {
    border-color: #777;
    background-color: #3a3a3a;
}

/* Multilevel Dropdown Menu Styles */
.dropdown-container {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.nav-menu-container {
    display: inline-block;
    position: relative;
}

#nav-menu {
    list-style: none;
    padding: 0;
    margin: 0;
    background-color: #333;
    border: 1px solid #555;
    border-radius: 4px;
    display: flex;
    flex-direction: row;
    gap: 0;
}

#nav-menu > li {
    position: relative;
    border-right: 1px solid #444;
}

#nav-menu > li:last-child {
    border-right: none;
}

#nav-menu > li > a {
    display: block;
    padding: 12px 20px;
    color: #f0f0f0;
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.2s;
    white-space: nowrap;
}

#nav-menu > li > a:hover {
    background-color: #3a3a3a;
}

#nav-menu li.has-submenu > a::after,
#sync-menu li.has-submenu > a::after {
    content: '▼';
    margin-left: 8px;
    font-size: 10px;
}

/* Submenu styles */
#nav-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
    position: absolute;
    left: 0;
    top: 100%;
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 4px;
    min-width: 120px;
    display: none;
    z-index: 1000;
    text-align: left;
}

#sync-menu {
    list-style: none;
    padding: 0;
    margin: 0;
    position: absolute;
    left: 0;
    top: 100%;
    background-color: #2a2a2a;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    min-width: var(--menu-width-sync-container);
    display: none;
    z-index: 1000;
    text-align: left;
}

/* Year menu - narrow width for 4-digit years, positioned below JOB NAV, right-aligned */
#years-menu {
    min-width: var(--menu-width-years) !important;
    left: auto !important;
    right: 0 !important;
    top: 100% !important;
}

/* Nested submenus (projects, apps, subdirs) */
#nav-menu ul ul {
    left: 100%;
    top: 0;
    min-width: var(--menu-width-standard);
}

#sync-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
    position: absolute;
    left: 100%;
    top: 0;
    min-width: var(--menu-width-standard);
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 4px;
    display: none;
    z-index: 1000;
    text-align: left;
}

#nav-menu li:hover > ul,
#sync-menu li:hover > ul {
    display: block;
}

/* Force all menus closed when this class is applied */
.menus-closed #nav-menu ul,
.menus-closed #sync-menu ul {
    display: none !important;
}

#nav-menu ul li {
    position: relative;
    border-bottom: 1px solid #333;
}

#sync-menu li {
    position: relative;
    border-bottom: 1px solid #333;
}

#nav-menu ul li:last-child {
    border-bottom: none;
}

#sync-menu li:last-child {
    border-bottom: none;
}

/* Consolidated menu link styles */
#nav-menu ul li a,
#sync-menu ul li a {
    display: block;
    padding: 10px 15px;
    font-size: 13px;
    color: var(--color-text);
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.2s;
    text-align: left;
}

#sync-menu > li > a {
    padding: 10px 18px;
    min-width: 140px;
}

#nav-menu ul li a:hover,
#sync-menu li a:hover {
    background-color: var(--color-background-hover);
}

#nav-menu ul li.has-submenu > a::after,
#sync-menu li.has-submenu > a::after {
    content: '▶';
    float: right;
    font-size: 10px;
}

.nav-placeholder {
    padding: 12px 20px;
    color: #888;
    font-style: italic;
    text-align: center;
}

.open-button {
    padding: 10px 30px;
    font-size: 16px;
    background-color: #4a9eff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.2s;
}

.open-button:disabled {
    background-color: #555;
    color: #888;
    cursor: not-allowed;
    opacity: 0.5;
}

.open-button:hover:not(:disabled) {
    background-color: #3a8eef;
}

.status-message {
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    border-radius: 4px;
    display: none;
}

.status-success {
    background-color: #4CAF50;
    color: white;
}

.status-error {
    background-color: #f44336;
    color: white;
}

.info-display {
    text-align: center;
    margin: 30px auto;
    max-width: 800px;
    padding: 20px;
    background-color: #2a2a2a;
    border-radius: 8px;
    color: #b0b0b0;
}

.info-display .path-display {
    font-family: monospace;
    background-color: #1a1a1a;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    word-break: break-all;
    color: #4CAF50;
}
{% endblock %}

{% block cart_icon %}{% endblock %}

{% block content %}

    <!-- <div style="text-align: center; margin-top: 30px;">
        <h1 style="color: #ffffff; font-size: 48px;">PRODUCTION</h1>
        <p style="color: #b0b0b0; font-size: 18px; margin-top: 10px;">
            Using database: {{ db_table }}
        </p>
    </div> -->

    <!-- Navigation Menu -->
    <div class="dropdown-container">
        <div class="nav-menu-container horizontal-menu">
            <ul id="nav-menu" class="horizontal-nav">

                <li id="project-select-root" class="has-submenu">
                    <a>JOB SET</a>
                    <ul id="storage-menu">
                        <!-- Storage sources will be populated here -->
                    </ul>
                </li>
                {% if show_sync_menu %}
                <li id="sync-select-root" class="has-submenu">
                    <a>JOB SYNC</a>
                    <ul id="sync-menu">
                        <!-- Sync directions will be populated here -->
                    </ul>
                </li>
                {% endif %}
                <li class="nav-button">
                    <a onclick="newProject()">JOB NEW</a>
                </li>
                <li class="nav-button">
                    <a onclick="research()">RESEARCH</a>
                </li>
                <li class="nav-button">
                    <a onclick="archive()">ARCHIVE</a>
                </li>
            </ul>
        </div>
    </div>


    <!-- Job Dashboard -->
    <div id="info-display" class="info-display" style="display: none; max-width: 900px; margin: 20px auto;">
        <h3 style="color: #4a9eff; margin-bottom: 20px; text-align: center;">Job Dashboard</h3>
        
        <!-- Info Display Section (for openDirectory feedback) -->
        <div style="margin-bottom: 20px; padding: 15px; background-color: #1a1a1a; border-radius: 4px;">
            <div>
                <!--<strong style="color: #aaa;">Opening Browser To:</strong>-->
                <span id="info-feedback" style="color: #4CAF50; margin-left: 10px; font-family: monospace;">-</span>
            </div>
            <!-- Hidden elements for JS compatibility -->
            <span id="info-project" style="display: none;"></span>
            <span id="info-app" style="display: none;"></span>
        </div>
        
        <form id="jobForm">
            <!-- Row 1: Job Name, Job Alias, Job State, Job Year -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Job Name</label>
                    <input type="text" id="job_name" name="job_name" readonly>
                </div>
                <div class="form-group">
                    <label>Job Alias</label>
                    <input type="text" id="job_alias" name="job_alias" readonly>
                </div>
                <div class="form-group">
                    <label>Job State</label>
                    <input type="text" id="job_state" name="job_state" readonly>
                </div>
                <div class="form-group">
                    <label>Job Year</label>
                    <input type="text" id="job_year" name="job_year" readonly>
                </div>
            </div>
            
            <!-- Row 2: Job User ID, Job User Name, Job Date Created -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Created: userId</label>
                    <input type="text" id="job_user_id" name="job_user_id" readonly>
                </div>
                <div class="form-group">
                    <label>Created: userName</label>
                    <input type="text" id="job_user_name" name="job_user_name" readonly>
                </div>
                <div class="form-group">
                    <label>Created Date</label>
                    <input type="text" id="job_date_created" name="job_date_created" readonly>
                </div>
            </div>
            
            <!-- Row 3: Edit User ID, Edit User Name, Edit Date -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Edited: userId</label>
                    <input type="text" id="job_edit_user_id" name="job_edit_user_id" readonly>
                </div>
                <div class="form-group">
                    <label>Edited: userName</label>
                    <input type="text" id="job_edit_user_name" name="job_edit_user_name" readonly>
                </div>
                <div class="form-group">
                    <label>Edited: Date</label>
                    <input type="text" id="job_edit_date" name="job_edit_date" readonly>
                </div>
            </div>
            
            <!-- Row 4: Paths -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Job Path</label>
                    <input type="text" id="job_path_job" name="job_path_job" readonly>
                </div>
                <div class="form-group">
                    <label>R&D Path</label>
                    <input type="text" id="job_path_rnd" name="job_path_rnd" readonly>
                </div>
            </div>
            
            <!-- Row 5: Charges and Date Due -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Job Charge 1</label>
                    <input type="text" id="job_charge1" name="job_charge1">
                </div>
                <div class="form-group">
                    <label>Job Charge 2</label>
                    <input type="text" id="job_charge2" name="job_charge2">
                </div>
                <div class="form-group">
                    <label>Job Charge 3</label>
                    <input type="text" id="job_charge3" name="job_charge3">
                </div>
                <div class="form-group">
                    <label>Date Due</label>
                    <input type="text" id="job_date_due" name="job_date_due">
                </div>
            </div>

            <!-- Row 6: Notes -->
            <div class="form-group">
                <label>Job Notes</label>
                <textarea id="job_notes" name="job_notes" rows="4" style="min-height: 80px;"></textarea>
            </div>
            
            <!-- Row 7: Tags -->
            <div class="form-group">
                <label>Job Tags</label>
                <input type="text" id="job_tags" name="job_tags">
            </div>
            
        </form>
    </div>

    <!-- Sync Confirmation Panel -->
    <div id="sync-confirmation" class="info-display" style="display: none; max-width: 700px; margin: 20px auto;">
        <h3 style="color: #4a9eff; margin-bottom: 20px; text-align: center;">Directory Sync Dashboard</h3>
        
        <div style="padding: 15px; background-color: #1a1a1a; border-radius: 4px; margin-bottom: 20px;">
            <div style="margin-bottom: 10px;">
                <strong style="color: #aaa;">Sync Direction:</strong>
                <span id="sync-direction-display" style="color: #ff9800; margin-left: 10px; font-weight: bold;">-</span>
            </div>
            <div style="margin-bottom: 10px;">
                <strong style="color: #aaa;">Path Src:</strong>
                <div id="sync-job-display" style="color: #4CAF50; margin-top: 5px; font-family: monospace; font-size: 12px; word-break: break-all; padding: 5px; background-color: #0a0a0a; border-radius: 3px;">-</div>
            </div>
            <div style="margin-bottom: 10px;">
                <strong style="color: #aaa;">Path Dst:</strong>
                <div id="sync-location-display" style="color: #4CAF50; margin-top: 5px; font-family: monospace; font-size: 12px; word-break: break-all; padding: 5px; background-color: #0a0a0a; border-radius: 3px;">-</div>
            </div>
            <!-- Combined Message Area: Warning/Progress/Result -->
            <div id="sync-message-area" style="margin-top: 15px; padding: 10px; background-color: #2a2a0a; border-left: 4px solid #ff9800; border-radius: 4px;">
                <strong id="sync-message-icon" style="color: #ff9800;">[!] Warning:</strong>
                <span id="sync-message-text" style="color: #f0f0f0; margin-left: 10px;">This will synchronize files between local and network storage. Files may be overwritten but not deleted.</span>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button type="button" id="btn-execute-sync" class="btn-primary" onclick="executeSynchronization()" style="padding: 10px 40px; background-color: #ff9800; min-width: 180px;">
                Synchronize Now
            </button>
            <button type="button" class="btn-secondary" onclick="cancelSynchronization()" style="padding: 10px 40px; background-color: #555; color: white; border: none; border-radius: 4px; cursor: pointer; min-width: 120px;">
                Cancel
            </button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div id="action-buttons" style="display: none; gap: 15px; margin-top: 20px; justify-content: center;">
        <button type="button" id="buttonEdit" class="btn-primary" onclick="jobEditOrSave()" style="padding: 10px 30px;">
            Edit Job
        </button>
        <button type="button" id="buttonCancel" class="btn-secondary" onclick="jobEditCancel()" style="padding: 10px 30px; background-color: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Cancel
        </button>
    </div>

    <!-- New Job Dashboard -->
    <div id="new-job-display" class="info-display" style="display: none; max-width: 600px; margin: 20px auto;">
        <h3 style="color: #4a9eff; margin-bottom: 20px; text-align: center;">New Job Dashboard</h3>
        
        <form id="newJobForm">
            <!-- Job Base -->
            <div class="form-group">
                <label>Job Base <span style="color: #aaa; font-size: 0.9em;"></span></label>
                <input type="text" id="new_job_base" name="job_base" placeholder="Create a descriptive, easy-to-type job name made up of letters, numbers, and underscores." oninput="validateJobBase()">
            </div>

            <!-- Validation Feedback -->
            <div id="validation-feedback" style="display: none; margin-top: 15px; margin-bottom: 15px; padding: 10px; background-color: #4a1a1a; border-left: 4px solid #ff4444; border-radius: 4px;">
                <span id="validation-feedback-text" style="color: #ff6666;">Only lowercase letters, numbers, and underscores allowed</span>
            </div>
            
            <!-- Job Name  -->
            <div class="form-group">
                <label>Job Name <span style="color: #aaa; font-size: 0.9em;"></span></label>
                <input type="text" id="new_job_name" name="job_name" readonly>
            </div>
            
            <!-- Job Alias  -->
            <div class="form-group">
                <label>Job Alias <span style="color: #aaa; font-size: 0.9em;"></span></label>
                <input type="text" id="new_job_alias" name="job_alias" readonly>
            </div>
            
            <!-- Job Path  -->
            <div class="form-group">
                <label>Job Path <span style="color: #aaa; font-size: 0.9em;"></span></label>
                <input type="text" id="new_job_path" name="job_path" readonly>
            </div>
            
        </form>
        
        <!-- Action Buttons for New Job -->
        <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
            <button type="button" id="btn-create-job" class="btn-primary" onclick="createNewJob()" style="padding: 10px 30px;">
                Create Job
            </button>
            <button type="button" class="btn-secondary" onclick="cancelNewJob()" style="padding: 10px 30px; background-color: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Cancel
            </button>
        </div>
    </div>

    <script>
        let years = {{ years|tojson }};
        let storageSources = {{ storage_sources|tojson }};
        let syncDirections = {{ sync_directions|tojson }};
        let menuBuilt = false;
        let syncMenuBuilt = false;
        let currentStorage = null;  // Track selected storage for API calls
        let currentSyncData = null;  // Track current sync operation data
        let currentSyncController = null;  // Track AbortController for cancelling sync
        
        // ========== REUSABLE HELPER FUNCTIONS ==========
        
        /**
         * Load job dashboard with project data and set appropriate feedback message
         * Consolidates repeated pattern of fetching job data
         */
        async function loadJobDashboard(projectName, projectPath, clickParams = null) {
            try {
                const response = await fetch('/api/action_jobactive_dashboard_populate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_name: projectName, job_path_job: projectPath })
                });
                
                const data = await response.json();
                
                if (data.success && data.job) {
                    populateJobForm(data.job);
                    
                    // Show the job dashboard
                    document.getElementById('info-display').style.display = 'block';
                    
                    // Update info-feedback based on what was clicked
                    if (clickParams) {
                        const {app, subdir, storage} = clickParams;
                        
                        if (!app) {
                            // Project level click - show "Job Set To:"
                            document.getElementById('info-feedback').textContent = 'Job Set To: ' + (data.job.job_path_job || projectPath);
                        } else {
                            // App or subdir click - show "Job Src:" and open directory
                            const displayPath = subdir ? `${projectPath}/${app}/${subdir}` : `${projectPath}/${app}`;
                            document.getElementById('info-feedback').textContent = 'Job Src: ' + displayPath;
                            
                            // Open directory for app/subdir clicks
                            openDirectory(projectPath, projectName, app, subdir, storage);
                        }
                    } else {
                        // Fallback
                        document.getElementById('info-feedback').textContent = data.job.job_path_job || projectPath || '-';
                    }
                    
                    return data.job;
                }
                
                showStatus('Error: ' + (data.message || 'Failed to load job data'), 'error');
                return null;
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                return null;
            }
        }
        
        /**
         * Build projects submenu for a given year
         * Reusable for both nav and sync menus
         */
        async function buildProjectsMenu(year, isSync = false, syncDirection = null, storage = null) {
            const projectsUnoList = document.createElement('ul');
            
            try {
                const response = await fetch(`/api/projects_by_year?year=${encodeURIComponent(year)}`);
                const data = await response.json();
                
                if (!data.projects || data.projects.length === 0) {
                    projectsUnoList.innerHTML = '<li class="nav-placeholder">No projects found</li>';
                    return projectsUnoList;
                }
                
                for (const project of data.projects) {
                    const projectListItem = document.createElement('li');
                    projectListItem.className = 'has-submenu';
                    
                    const projectAnchor = document.createElement('a');
                    projectAnchor.textContent = project.name;
                    projectListItem.appendChild(projectAnchor);
                    
                    // Add click handler
                    if (isSync) {
                        projectAnchor.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showSyncConfirmation(project.path, project.name, null, null, syncDirection);
                        });
                    } else {
                        projectAnchor.addEventListener('click', (e) => {
                            e.stopPropagation();
                            closeAllMenus();
                            // Open directory at project level (app=null) and load dashboard
                            loadJobDashboard(project.name, project.path, {app: null, subdir: null, storage: storage});
                        });
                    }
                    
                    // Lazy load apps on hover
                    projectAnchor.addEventListener('mouseenter', async function() {
                        if (projectListItem.querySelector('ul')) return;
                        const appsMenu = await buildAppsMenu(project, isSync, syncDirection, storage);
                        projectListItem.appendChild(appsMenu);
                    });
                    
                    projectsUnoList.appendChild(projectListItem);
                }
            } catch (error) {
                projectsUnoList.innerHTML = '<li class="nav-placeholder">Error loading projects</li>';
                console.error('Error fetching projects:', error);
            }
            
            return projectsUnoList;
        }
        
        /**
         * Build apps submenu for a given project
         * Reusable for both nav and sync menus
         */
        async function buildAppsMenu(project, isSync = false, syncDirection = null, storage = null) {
            const appsUnoList = document.createElement('ul');
            
            try {
                const response = await fetch(`/api/apps_by_project?project=${encodeURIComponent(project.name)}`);
                const data = await response.json();
                
                if (!data.apps || data.apps.length === 0) {
                    appsUnoList.innerHTML = '<li class="nav-placeholder">No apps found</li>';
                    return appsUnoList;
                }
                
                for (const app of data.apps) {
                    const subdirResponse = await fetch(`/api/subdirs_by_app?app=${encodeURIComponent(app)}`);
                    const subdirData = await subdirResponse.json();
                    
                    const appListItem = document.createElement('li');
                    const appAnchor = document.createElement('a');
                    appAnchor.textContent = app;
                    
                    if (subdirData.subdirs && subdirData.subdirs.length > 0) {
                        appListItem.className = 'has-submenu';
                        
                        // Add click handler
                        if (isSync) {
                            appAnchor.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showSyncConfirmation(project.path, project.name, app, null, syncDirection);
                            });
                        } else {
                            appAnchor.addEventListener('click', (e) => {
                                e.stopPropagation();
                                loadJobDashboard(project.name, project.path, {app, subdir: null, storage});
                            });
                        }
                        
                        // Build subdirs submenu
                        const subdirsUnoList = document.createElement('ul');
                        subdirData.subdirs.forEach(subdir => {
                            const subdirListItem = document.createElement('li');
                            const subdirAnchor = document.createElement('a');
                            subdirAnchor.textContent = subdir;
                            
                            if (isSync) {
                                subdirAnchor.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    showSyncConfirmation(project.path, project.name, app, subdir, syncDirection);
                                });
                            } else {
                                subdirAnchor.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    loadJobDashboard(project.name, project.path, {app, subdir, storage});
                                });
                            }
                            
                            subdirListItem.appendChild(subdirAnchor);
                            subdirsUnoList.appendChild(subdirListItem);
                        });
                        
                        appListItem.appendChild(appAnchor);
                        appListItem.appendChild(subdirsUnoList);
                    } else {
                        // No subdirs - simple link
                        if (isSync) {
                            appAnchor.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showSyncConfirmation(project.path, project.name, app, null, syncDirection);
                            });
                        } else {
                            appAnchor.addEventListener('click', (e) => {
                                e.stopPropagation();
                                loadJobDashboard(project.name, project.path, {app, subdir: null, storage});
                            });
                        }
                        appListItem.appendChild(appAnchor);
                    }
                    
                    appsUnoList.appendChild(appListItem);
                }
            } catch (error) {
                appsUnoList.innerHTML = '<li class="nav-placeholder">Error loading apps</li>';
                console.error('Error fetching apps:', error);
            }
            
            return appsUnoList;
        }

        // Build storage sources menu on first hover of JOB NAV button
        document.getElementById('project-select-root').addEventListener('mouseenter', async function() {
            if (menuBuilt) return;
            menuBuilt = true;
            
            const storageMenu = document.getElementById('storage-menu');
            storageMenu.innerHTML = '<li class="nav-placeholder">Loading...</li>';
            
            try {
                storageMenu.innerHTML = '';
                
                // Build storage sources as first level
                for (const storage of storageSources) {
                    const storageListItem = document.createElement('li');
                    storageListItem.className = 'has-submenu';
                    
                    const storageAnchor = document.createElement('a');
                    storageAnchor.textContent = storage;
                    storageListItem.appendChild(storageAnchor);
                    
                    // Lazy load years when storage is hovered
                    storageListItem.addEventListener('mouseenter', async function() {
                        if (this.dataset.loaded) return;
                        this.dataset.loaded = 'true';
                        
                        currentStorage = storage;  // Track current storage
                        const selectedStorage = storage;  // Capture in closure for nested handlers
                        
                        const yearsUnoList = document.createElement('ul');
                        
                        for (const year of years) {
                            const yearListItem = document.createElement('li');
                            yearListItem.className = 'has-submenu';
                            
                            const yearAnchor = document.createElement('a');
                            yearAnchor.textContent = year;
                            yearListItem.appendChild(yearAnchor);
                            
                            // Lazy load projects when year is hovered
                            yearAnchor.addEventListener('mouseenter', async function() {
                                if (yearListItem.querySelector('ul')) return;
                                const projectsMenu = await buildProjectsMenu(year, false, null, selectedStorage);
                                yearListItem.appendChild(projectsMenu);
                            });
                            
                            yearsUnoList.appendChild(yearListItem);
                        }
                        
                        this.appendChild(yearsUnoList);
                    }, { once: true });
                    
                    storageMenu.appendChild(storageListItem);
                }
            } catch (error) {
                storageMenu.innerHTML = '<li class="nav-placeholder">Error loading menu</li>';
                showStatus('Error building navigation menu: ' + error.message, 'error');
            }
        }, { once: true });

        // Build sync menu on first hover of JOB SYNC button - now using reusable functions
        const syncSelectRoot = document.getElementById('sync-select-root');
        if (syncSelectRoot) {
            syncSelectRoot.addEventListener('mouseenter', async function() {
            if (syncMenuBuilt) return;
            syncMenuBuilt = true;
            
            const syncMenu = document.getElementById('sync-menu');
            syncMenu.innerHTML = '<li class="nav-placeholder">Loading...</li>';
            
            try {
                syncMenu.innerHTML = '';
                
                // Build sync directions menu
                for (const syncDirection of syncDirections) {
                    const syncDirectionListItem = document.createElement('li');
                    syncDirectionListItem.className = 'has-submenu';
                    
                    const syncDirectionAnchor = document.createElement('a');
                    syncDirectionAnchor.textContent = syncDirection;
                    syncDirectionListItem.appendChild(syncDirectionAnchor);
                    
                    const yearsUnoList = document.createElement('ul');
                    syncDirectionListItem.appendChild(yearsUnoList);
                    
                    // Lazy load years cascade on hover
                    syncDirectionAnchor.addEventListener('mouseenter', function() {
                        if (yearsUnoList.children.length > 0) return;
                        
                        for (const year of years) {
                            const yearListItem = document.createElement('li');
                            yearListItem.className = 'has-submenu';
                            
                            const yearAnchor = document.createElement('a');
                            yearAnchor.textContent = year;
                            yearListItem.appendChild(yearAnchor);
                            
                            // Lazy load projects when year is hovered
                            yearAnchor.addEventListener('mouseenter', async function() {
                                if (yearListItem.querySelector('ul')) return;
                                const projectsMenu = await buildProjectsMenu(year, true, syncDirection);
                                yearListItem.appendChild(projectsMenu);
                            });
                            
                            yearsUnoList.appendChild(yearListItem);
                        }
                    });
                    
                    syncMenu.appendChild(syncDirectionListItem);
                }
            } catch (error) {
                syncMenu.innerHTML = '<li class="nav-placeholder">Error loading sync menu</li>';
                showStatus('Error building sync menu: ' + error.message, 'error');
            }
        }, { once: true });
        }

        function showSyncConfirmation(jobPath, projectName, app, subdir, syncDirection) {
            // Close all menus
            closeAllMenus();
            
            // Hide all other dashboards
            hideAllDashboards();
            
            // Store sync data
            currentSyncData = {
                job_path_job: jobPath,
                project_name: projectName,
                app: app,
                subdir: subdir,
                sync_direction: syncDirection
            };
            
            // Update confirmation panel
            document.getElementById('sync-direction-display').textContent = syncDirection;
            
            // Fetch and display actual paths
            fetch('/api/get_sync_paths', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    job_path_job: jobPath,
                    app: app,
                    subdir: subdir,
                    sync_direction: syncDirection
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display paths based on sync direction
                    if (syncDirection === 'LOCAL TO NETWK') {
                        document.getElementById('sync-job-display').textContent = data.path_local || '-';
                        document.getElementById('sync-location-display').textContent = data.path_netwk || '-';
                    } else {
                        document.getElementById('sync-job-display').textContent = data.path_netwk || '-';
                        document.getElementById('sync-location-display').textContent = data.path_local || '-';
                    }
                } else {
                    // Fallback to project name if API fails
                    document.getElementById('sync-job-display').textContent = projectName;
                    let locationText = '-';
                    if (app) {
                        locationText = app;
                        if (subdir) {
                            locationText += ' / ' + subdir;
                        }
                    } else {
                        locationText = 'Project Root';
                    }
                    document.getElementById('sync-location-display').textContent = locationText;
                }
            })
            .catch(error => {
                console.error('Error fetching paths:', error);
                // Fallback display
                document.getElementById('sync-job-display').textContent = projectName;
                let locationText = '-';
                if (app) {
                    locationText = app;
                    if (subdir) {
                        locationText += ' / ' + subdir;
                    }
                } else {
                    locationText = 'Project Root';
                }
                document.getElementById('sync-location-display').textContent = locationText;
            });
            
            // Reset message area to default warning state
            const messageArea = document.getElementById('sync-message-area');
            messageArea.style.backgroundColor = '#2a2a0a';
            messageArea.style.borderLeft = '4px solid #ff9800';
            document.getElementById('sync-message-icon').innerHTML = '[!] Warning:';
            document.getElementById('sync-message-icon').style.color = '#ff9800';
            document.getElementById('sync-message-text').textContent = 'This will synchronize files between local and network storage.\nFiles in destination may be overwritten but not deleted.';
            
            // Show confirmation panel
            document.getElementById('sync-confirmation').style.display = 'block';
            
            // Scroll to confirmation panel
            document.getElementById('sync-confirmation').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function cancelSynchronization() {
            // Abort the sync operation if it's in progress
            if (currentSyncController) {
                currentSyncController.abort();
                currentSyncController = null;
            }
            
            // Re-enable button
            const btnExecute = document.getElementById('btn-execute-sync');
            btnExecute.disabled = false;
            btnExecute.textContent = 'Synchronize Now';
            
            // Show cancellation message and keep dashboard visible
            const messageArea = document.getElementById('sync-message-area');
            messageArea.style.backgroundColor = '#3a3a1a';
            messageArea.style.borderLeft = '4px solid #888';
            document.getElementById('sync-message-icon').innerHTML = '[x] Cancelled:';
            document.getElementById('sync-message-icon').style.color = '#888';
            document.getElementById('sync-message-text').textContent = 'Synchronization cancelled by user';
            
            // Keep dashboard visible - do not hide
        }

        function executeSynchronization() {
            if (!currentSyncData) {
                // Show error in message area
                const messageArea = document.getElementById('sync-message-area');
                messageArea.style.backgroundColor = '#3a1a1a';
                messageArea.style.borderLeft = '4px solid #f44336';
                document.getElementById('sync-message-icon').innerHTML = '✗ Error:';
                document.getElementById('sync-message-icon').style.color = '#f44336';
                document.getElementById('sync-message-text').textContent = 'No sync operation selected';
                return;
            }
            
            // Disable button during sync
            const btnExecute = document.getElementById('btn-execute-sync');
            btnExecute.disabled = true;
            btnExecute.textContent = 'Synchronizing...';
            
            // Show progress message in the message area
            const messageArea = document.getElementById('sync-message-area');
            messageArea.style.backgroundColor = '#2a4a6a';
            messageArea.style.borderLeft = '4px solid #4CAF50';
            document.getElementById('sync-message-icon').innerHTML = '[~]';
            document.getElementById('sync-message-icon').style.color = '#4CAF50';
            document.getElementById('sync-message-text').textContent = 'Synchronization in progress... Please wait.';
            
            // Create AbortController for cancellation
            currentSyncController = new AbortController();
            
            // Call sync API
            fetch('/api/sync_directory', {
                signal: currentSyncController.signal,
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    job_path_job: currentSyncData.job_path_job,
                    app: currentSyncData.app,
                    subdir: currentSyncData.subdir,
                    sync_direction: currentSyncData.sync_direction
                })
            })
            .then(response => response.json())
            .then(data => {
                btnExecute.disabled = false;
                btnExecute.textContent = 'Synchronize Now';
                
                if (data.success) {
                    // Show success message
                    messageArea.style.backgroundColor = '#1a3a1a';
                    messageArea.style.borderLeft = '4px solid #4CAF50';
                    document.getElementById('sync-message-icon').innerHTML = '[+] Success:';
                    document.getElementById('sync-message-icon').style.color = '#4CAF50';
                    document.getElementById('sync-message-text').textContent = data.message;
                    
                    // Stay in sync dashboard - do not clear or hide
                } else {
                    // Show error message
                    messageArea.style.backgroundColor = '#3a1a1a';
                    messageArea.style.borderLeft = '4px solid #f44336';
                    document.getElementById('sync-message-icon').innerHTML = '✗ Error:';
                    document.getElementById('sync-message-icon').style.color = '#f44336';
                    document.getElementById('sync-message-text').textContent = data.message;
                }
            })
            .catch(error => {
                // Check if error is due to abort (cancellation)
                if (error.name === 'AbortError') {
                    // Cancellation already handled by cancelSynchronization
                    return;
                }
                
                btnExecute.disabled = false;
                btnExecute.textContent = 'Synchronize Now';
                
                // Show error message
                messageArea.style.backgroundColor = '#3a1a1a';
                messageArea.style.borderLeft = '4px solid #f44336';
                document.getElementById('sync-message-icon').innerHTML = '✗ Error:';
                document.getElementById('sync-message-icon').style.color = '#f44336';
                document.getElementById('sync-message-text').textContent = error.message;
            })
            .finally(() => {
                // Clear controller after request completes
                currentSyncController = null;
            });
        }

        function openDirectory(jobPath, projectName, app, subdir, storage) {
            // Close all menus immediately
            closeAllMenus();
            
            // Hide sync and new job dashboards (nav dashboard will be shown)
            document.getElementById('new-job-display').style.display = 'none';
            document.getElementById('sync-confirmation').style.display = 'none';
            
            // Use passed storage parameter (required)
            const storageSource = storage;
            
            // This function is now only called for app/subdir clicks (not project-level)
            if (!jobPath || !app) {
                console.error('openDirectory called without required parameters');
                return;
            }
            
            // Update info display fields
            document.getElementById('info-project').textContent = projectName;
            document.getElementById('info-app').textContent = subdir ? `${app}/${subdir}` : app;
            document.getElementById('info-display').style.display = 'block';
            
            // Call API to open directory immediately
            fetch('/api/open_app_directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    job_path_job: jobPath,
                    app: app,
                    subdir: subdir || null,
                    storage_src: storageSource
                })
            })
            .then(response => response.json())
            .then(data => {
                // Only show error if directory opening failed
                if (!data.success) {
                    const currentFeedback = document.getElementById('info-feedback').textContent;
                    document.getElementById('info-feedback').textContent = currentFeedback + ' [Error: ' + data.message + ']';
                }
            })
            .catch(error => {
                const currentFeedback = document.getElementById('info-feedback').textContent;
                document.getElementById('info-feedback').textContent = currentFeedback + ' [Error: ' + error.message + ']';
            });
        }

        function closeAllMenus() {
            // Add class to nav container to force all menus closed
            const navContainer = document.querySelector('.nav-menu-container');
            navContainer.classList.add('menus-closed');
            
            // Remove the class after a short delay so menus can be opened again on next hover
            setTimeout(() => {
                navContainer.classList.remove('menus-closed');
            }, 300);
        }

        function hideAllDashboards() {
            document.getElementById('info-display').style.display = 'none';
            document.getElementById('new-job-display').style.display = 'none';
            document.getElementById('sync-confirmation').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'none';
        }

        function showStatus(message, type) {
            const feedbackDiv = document.getElementById('info-feedback');
            feedbackDiv.textContent = message;
            document.getElementById('info-display').style.display = 'block';
        }
        
        function newProject() {
            // Hide all other dashboards
            hideAllDashboards();
            
            // Clear and show new job dashboard
            document.getElementById('new_job_base').value = '';
            document.getElementById('new_job_name').value = '';
            document.getElementById('new_job_alias').value = '';
            document.getElementById('new_job_path').value = '';
            document.getElementById('validation-feedback').style.display = 'none';
            document.getElementById('new-job-display').style.display = 'block';
            
            // Reset field colors
            document.getElementById('new_job_name').style.color = '#f0f0f0';
            document.getElementById('new_job_alias').style.color = '#f0f0f0';
            
            // Close all menus
            closeAllMenus();
        }
        
        function research() {
            window.open('/search', '_blank');
        }
        
        function archive() {
            window.open('/archive', '_blank');
        }
        
        // Populate job dashboard form with job data
        // Constants for button states
        const jobContextEdit = 'Edit Job Info';
        const jobContextSave = 'Save Job Info';
        
        // List of editable fields (matching list_columns_editable in backend)
        const editableFields = ['job_date_due', 'job_charge1', 'job_charge2', 'job_charge3', 'job_tags', 'job_notes'];
        
        // Store original job data for cancel/restore functionality
        let originalJobData = null;
        
        function populateJobForm(job) {
            // Hide sync and new job dashboards (nav dashboard will be populated)
            document.getElementById('new-job-display').style.display = 'none';
            document.getElementById('sync-confirmation').style.display = 'none';
            
            // Store original job data for cancel functionality
            originalJobData = JSON.parse(JSON.stringify(job)); // Deep copy
            
            document.getElementById('job_name').value = job.job_name || '';
            document.getElementById('job_alias').value = job.job_alias || '';
            document.getElementById('job_state').value = job.job_state || '';
            document.getElementById('job_year').value = job.job_year || '';
            document.getElementById('job_user_id').value = job.job_user_id || '';
            document.getElementById('job_user_name').value = job.job_user_name || '';
            document.getElementById('job_date_created').value = job.job_date_created || '';
            document.getElementById('job_edit_user_id').value = job.job_edit_user_id || '';
            document.getElementById('job_edit_user_name').value = job.job_edit_user_name || '';
            document.getElementById('job_edit_date').value = job.job_edit_date || '';
            document.getElementById('job_date_created').value = job.job_date_created || '';
            document.getElementById('job_date_due').value = job.job_date_due || '';
            document.getElementById('job_charge1').value = job.job_charge1 || '';
            document.getElementById('job_charge2').value = job.job_charge2 || '';
            document.getElementById('job_charge3').value = job.job_charge3 || '';
            document.getElementById('job_path_job').value = job.job_path_job || '';
            document.getElementById('job_path_rnd').value = job.job_path_rnd || '';
            document.getElementById('job_tags').value = job.job_tags || '';
            document.getElementById('job_notes').value = job.job_notes || '';
            
            // Disable all editable fields initially
            editableFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.disabled = true;
            });
            
            // Reset button to "Edit Job" mode
            const editButton = document.querySelector('button[onclick="jobEditOrSave()"]');
            if (editButton) {
                editButton.textContent = jobContextEdit;
                editButton.dataset.mode = 'edit';
            }
            
            // Show action buttons when job is loaded
            document.getElementById('action-buttons').style.display = 'flex';
        }
        
        // Toggle between Edit and Save modes
        async function jobEditOrSave() {
            const editButton = document.querySelector('button[onclick="jobEditOrSave()"]');
            const mode = editButton.dataset.mode || 'edit';
            
            if (mode === 'edit') {
                // Switch to edit mode: enable editable fields
                editableFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.disabled = false;
                });
                
                // Change button to "Save Job"
                editButton.textContent = jobContextSave;
                editButton.dataset.mode = 'save';
                
            } else {
                // Save mode: send data to backend
                const formData = {
                    job_name: document.getElementById('job_name').value
                };
                
                // Only include editable fields in the update
                editableFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        formData[fieldId] = field.value || '';
                    }
                });
                
                try {
                    const response = await fetch('/api/action_jobactive_dashboard_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showStatus('Job data saved successfully', 'success');
                        
                        // Disable fields again and switch back to edit mode
                        editableFields.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (field) field.disabled = true;
                        });
                        
                        editButton.textContent = jobContextEdit;
                        editButton.dataset.mode = 'edit';
                    } else {
                        showStatus('Error saving job data: ' + (data.message || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showStatus('Error saving job data: ' + error.message, 'error');
                }
            }
        }
        
        // New Job
        function jobEditNew() {
            document.getElementById('info-display').style.display = 'none';
            // Optionally reload original data
        }
        
        // Cancel job edit
        function jobEditCancel() {
            const editButton = document.querySelector('button[onclick="jobEditOrSave()"]');
            const mode = editButton.dataset.mode || 'edit';
            
            // If in edit mode (fields are enabled), reload original data and disable fields
            if (mode === 'save') {
                // Restore original data if available
                if (originalJobData) {
                    populateJobForm(originalJobData);
                } else {
                    // Just disable fields if no original data stored
                    editableFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) field.disabled = true;
                    });
                    
                    // Switch button back to "Edit Job" mode
                    editButton.textContent = jobContextEdit;
                    editButton.dataset.mode = 'edit';
                }
            } else {
                // Not in edit mode, just hide the dashboard and buttons
                document.getElementById('info-display').style.display = 'none';
                document.getElementById('action-buttons').style.display = 'none';
            }
        }
        
        // Validate job base as user types
        async function validateJobBase() {
            const jobBase = document.getElementById('new_job_base').value;
            const jobNameField = document.getElementById('new_job_name');
            const jobAliasField = document.getElementById('new_job_alias');
            const jobPathField = document.getElementById('new_job_path');
            const feedbackDiv = document.getElementById('validation-feedback');
            const createButton = document.getElementById('btn-create-job');
            
            // Clear fields if job_base is empty
            if (!jobBase) {
                jobNameField.value = '';
                jobAliasField.value = '';
                jobPathField.value = '';
                jobNameField.style.color = '#f0f0f0';
                jobAliasField.style.color = '#f0f0f0';
                feedbackDiv.style.display = 'none';
                createButton.disabled = true;
                return;
            }
            
            try {
                // Call backend API to validate and generate job name/alias
                const response = await fetch('/api/job_name_validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_base: jobBase })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    // Valid input - show generated values in normal color
                    jobNameField.value = data.job_name || '';
                    jobAliasField.value = data.job_alias || '';
                    jobPathField.value = data.job_path || '';
                    jobNameField.style.color = '#4CAF50';
                    jobAliasField.style.color = '#4CAF50';
                    feedbackDiv.style.display = 'none';
                    createButton.disabled = false;
                } else {
                    // Invalid input - show error feedback with specific reason
                    jobNameField.value = '';
                    jobAliasField.value = '';
                    jobPathField.value = '';
                    jobNameField.style.color = '#ff4444';
                    jobAliasField.style.color = '#ff4444';
                    createButton.disabled = true;
                    
                    // Update feedback message with specific validation reason
                    const feedbackText = document.getElementById('validation-feedback-text');
                    if (feedbackText && data.reason) {
                        feedbackText.textContent = data.reason;
                    }
                    feedbackDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error validating job base:', error);
            }
        }
        
        // Create new job
        async function createNewJob() {
            const jobBase = document.getElementById('new_job_base').value;
            const jobName = document.getElementById('new_job_name').value;
            const jobAlias = document.getElementById('new_job_alias').value;
            
            if (!jobBase || !jobName || !jobAlias) {
                showStatus('Please enter a valid job base', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/job_new_create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        job_base: jobBase,
                        job_name: jobName,
                        job_alias: jobAlias
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('Job created successfully: ' + data.job_name, 'success');
                    cancelNewJob();
                    
                    // Load the new job into the Job Dashboard and enter edit mode
                    if (data.job_data) {
                        // Show the job dashboard with the new job data
                        document.getElementById('info-display').style.display = 'block';
                        populateJobForm(data.job_data);
                        
                        // Automatically enter edit mode
                        const editButton = document.querySelector('button[onclick="jobEditOrSave()"]');
                        if (editButton && editButton.dataset.mode === 'edit') {
                            // Trigger edit mode by simulating the button click logic
                            editableFields.forEach(fieldId => {
                                const field = document.getElementById(fieldId);
                                if (field) field.disabled = false;
                            });
                            editButton.textContent = jobContextSave;
                            editButton.dataset.mode = 'save';
                        }
                    }
                } else {
                    showStatus('Error creating job: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('Error creating job: ' + error.message, 'error');
            }
        }
        
        // Cancel new job creation
        function cancelNewJob() {
            document.getElementById('new-job-display').style.display = 'none';
            document.getElementById('new_job_base').value = '';
            document.getElementById('new_job_name').value = '';
            document.getElementById('new_job_alias').value = '';
            document.getElementById('new_job_path').value = '';
        }
    </script>

{% endblock %}
