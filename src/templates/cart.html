{% extends "base.html" %}

{% block title %}Media Gallery - Cart{% endblock %}

{% block extra_styles %}
body {
    padding: 80px 20px 20px 20px;
}

table {
    border: 1px solid #555;
    margin: 20px auto;
    min-width: 1300px;
}

.editable-cell {
    position: relative;
}

.editable-cell input,
.editable-cell textarea {
    width: 100%;
    background-color: #333;
    color: #f0f0f0;
    border: 1px solid #666;
    padding: 4px;
    box-sizing: border-box;
}

.editable-cell textarea {
    resize: vertical;
    min-height: 60px;
}

.modified {
    background-color: #3a3a00 !important;
}

.edit-buttons {
    display: none;
}

#editModeMsg {
    display: none;
    text-align: center;
    color: #ffcc00;
    font-weight: bold;
    margin: 10px 0;
}

.context-menu {
    display: none;
    position: fixed;
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 5px 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    z-index: 10000;
    min-width: 180px;
}

.context-menu-item {
    padding: 8px 16px;
    cursor: pointer;
    color: #f0f0f0;
    transition: background-color 0.2s;
}

.context-menu-item:hover {
    background-color: #4da6ff;
}
{% endblock %}

{% block cart_icon %}
    <!-- No cart icon on cart page itself -->
{% endblock %}

{% block header_spacing %}<br>{% endblock %}

{% block header_link %}<a href="{{ back_url }}">MEDIA GALLERY</a>{% endblock %}

{% block content %}
    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" id="applyToSelected">Apply to Selected Items</div>
    </div>

    {% if not media %}
    <p style="text-align: center;">Cart is empty</p>
    {% endif %}

    {% if media %}
    <form method="POST" action="{{ url_for('cart_download') }}">
        <input type="hidden" name="db_table" value="{{ db_table }}">
        <div style="text-align: center; margin: 20px;">
            <div class="normal-buttons">
                <a href="{{ url_for('cart_clear', db_table=db_table) }}"><button type="button">Clear Cart</button></a>
                <button type="submit" id="downloadBtn" style="margin-left: 10px;">Download Selected</button>
                <button type="button" id="editBtn" style="margin-left: 10px;">Edit DB</button>
                <button type="button" id="pruneBtn" style="margin-left: 10px; background-color: #d32f2f; color: white;">Prune DB</button>
            </div>
            <div class="edit-buttons">
                <button type="button" id="saveBtn" style="background-color: #4CAF50;">Save Changes</button>
                <button type="button" id="cancelBtn" style="margin-left: 10px; background-color: #f44336;">Cancel</button>
            </div>
        </div>
        <div id="editModeMsg">EDIT MODE - Modify fields and click Save Changes</div>
        <table>
            <thead>
                <tr>
                    <th style="width: 20px;"><button type="button" id="toggleAll" style="padding: 5px 5px; cursor: pointer;">Sel</button></th>
                    <th style="width: 300px;">Media</th>
                    <th style="width: 120px;">Subject</th>
                    <th style="width: 120px;">Genre</th>
                    <th style="width: 120px;">Setting</th>
                    <th style="width: 300px;">Captions</th>
                    <th style="width: 300px;">Tags</th>
                </tr>
            </thead>
            <tbody>
                {% for media_item in media %}
                <tr>
                    <td style="text-align: center;"><input type="checkbox" name="selected" value="{{ media_item['file_id'] }}" checked></td>
                    <td style="text-align: center;">
                        <div class="media-card">
                            {% if media_item['ext_is_viewable'] %}
                            {% if media_item['file_type'] == 'mp4' %}
                            <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                                 alt="{{ media_item['file_name'] }}"
                                 class="thumbnail"
                                 data-open-video="{{ url_for('static', filename=media_item['relative_path']) }}"
                                 data-poster="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">
                            <button type="button" class="play-button"
                                    data-open-video="{{ url_for('static', filename=media_item['relative_path']) }}"
                                    data-poster="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">â–¶</button>
                            {% else %}
                            <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                                 alt="{{ media_item['file_name'] }}"
                                 class="thumbnail"
                                 data-open-image="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}">
                            {% endif %}
                            {% else %}
                            <img src="{{ url_for('static', filename=media_item['thumbnail_relative_path']) }}" 
                                 alt="{{ media_item['file_name'] }}"
                                 class="thumbnail"
                                 style="cursor: pointer;"
                                 data-download-file="{{ url_for('static', filename=media_item['relative_path']) }}"
                                 data-download-name="{{ media_item['file_name'] }}">
                            {% endif %}
                        </div>
                        <p style="text-align: center; margin: 5px 0 0 0; font-size: 12px; word-break: break-all;">{{ media_item['file_name'] }}</p>
                    </td>
                    <td class="editable-cell" data-field="subject" data-file-id="{{ media_item['file_id'] }}">
                        <span class="view-mode">{{ media_item['subject'] }}</span>
                    </td>
                    <td class="editable-cell" data-field="genre" data-file-id="{{ media_item['file_id'] }}">
                        <span class="view-mode">{{ media_item['genre'] }}</span>
                    </td>
                    <td class="editable-cell" data-field="setting" data-file-id="{{ media_item['file_id'] }}">
                        <span class="view-mode">{{ media_item['setting'] }}</span>
                    </td>
                    <td class="editable-cell" data-field="captions" data-file-id="{{ media_item['file_id'] }}">
                        <span class="view-mode">{{ media_item['captions'] }}</span>
                    </td>
                    <td class="editable-cell" data-field="tags" data-file-id="{{ media_item['file_id'] }}">
                        <span class="view-mode">{{ media_item['tags'] }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="text-align: center; margin: 20px;">
            <div class="normal-buttons">
                <a href="{{ url_for('cart_clear', db_table=db_table) }}"><button type="button">Clear Cart</button></a>
                <button type="submit" id="downloadBtn2" style="margin-left: 10px;">Download Selected</button>
                <button type="button" id="editBtn2" style="margin-left: 10px;">Edit DB</button>
                <button type="button" id="pruneBtn2" style="margin-left: 10px; background-color: #d32f2f; color: white;">Prune DB</button>
            </div>
            <div class="edit-buttons">
                <button type="button" id="saveBtn2" style="background-color: #4CAF50;">Save Changes</button>
                <button type="button" id="cancelBtn2" style="margin-left: 10px; background-color: #f44336;">Cancel</button>
            </div>
        </div>
    </form>
    {% endif %}
{% endblock %}

{% block extra_scripts %}
    <script>
        const checkboxes = document.querySelectorAll('input[name="selected"]');
        const button1 = document.getElementById('downloadBtn');
        const button2 = document.getElementById('downloadBtn2');

        function updateButtons() {
            const checked = Array.from(checkboxes).some(cb => cb.checked);
            if (button1) button1.disabled = !checked;
            if (button2) button2.disabled = !checked;
        }

        if (checkboxes.length > 0) {
            checkboxes.forEach(cb => cb.addEventListener('change', updateButtons));
            updateButtons();
        }

        // Toggle all checkboxes
        const toggleAllBtn = document.getElementById('toggleAll');
        if (toggleAllBtn) {
            toggleAllBtn.addEventListener('click', function() {
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
                updateButtons();
            });
        }

        // Edit mode functionality
        let isEditMode = false;
        let originalData = {};
        const editableFields = ['subject', 'genre', 'setting', 'captions', 'tags'];

        const editBtn = document.getElementById('editBtn');
        const editBtn2 = document.getElementById('editBtn2');
        const saveBtn = document.getElementById('saveBtn');
        const saveBtn2 = document.getElementById('saveBtn2');
        const cancelBtn = document.getElementById('cancelBtn');
        const cancelBtn2 = document.getElementById('cancelBtn2');
        const pruneBtn = document.getElementById('pruneBtn');
        const pruneBtn2 = document.getElementById('pruneBtn2');
        const editModeMsg = document.getElementById('editModeMsg');
        const normalButtons = document.querySelectorAll('.normal-buttons');
        const editButtons = document.querySelectorAll('.edit-buttons');

        if (editBtn) editBtn.addEventListener('click', enterEditMode);
        if (editBtn2) editBtn2.addEventListener('click', enterEditMode);
        if (saveBtn) saveBtn.addEventListener('click', saveChanges);
        if (saveBtn2) saveBtn2.addEventListener('click', saveChanges);
        if (cancelBtn) cancelBtn.addEventListener('click', cancelEdit);
        if (cancelBtn2) cancelBtn2.addEventListener('click', cancelEdit);
        if (pruneBtn) pruneBtn.addEventListener('click', pruneSelected);
        if (pruneBtn2) pruneBtn2.addEventListener('click', pruneSelected);

        function enterEditMode() {
            isEditMode = true;
            originalData = {};
            
            // Hide normal buttons, show edit buttons
            normalButtons.forEach(el => el.style.display = 'none');
            editButtons.forEach(el => el.style.display = 'inline-block');
            editModeMsg.style.display = 'block';

            // Convert all editable cells to inputs
            document.querySelectorAll('.editable-cell').forEach(cell => {
                const field = cell.dataset.field;
                const fileId = cell.dataset.fileId;
                const span = cell.querySelector('.view-mode');
                const value = span.textContent.trim();
                
                // Store original value
                if (!originalData[fileId]) originalData[fileId] = {};
                originalData[fileId][field] = value;

                // Create input, textarea, or select
                let input;
                if (field === 'captions') {
                    input = document.createElement('textarea');
                    input.rows = 3;
                } else if (field === 'genre') {
                    input = document.createElement('select');
                    // Add empty option
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Select Genre --';
                    input.appendChild(emptyOption);
                    // Add genre options
                    const genres = {{ genres|tojson }};
                    genres.forEach(genre => {
                        const option = document.createElement('option');
                        option.value = genre;
                        option.textContent = genre;
                        if (genre === value) {
                            option.selected = true;
                        }
                        input.appendChild(option);
                    });
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }
                if (field !== 'genre') {
                    input.value = value;
                }
                input.dataset.field = field;
                input.dataset.fileId = fileId;
                input.className = 'edit-input';

                // Track changes (use both 'input' and 'change' for select compatibility)
                const changeHandler = function() {
                    if (this.value !== originalData[fileId][field]) {
                        cell.classList.add('modified');
                    } else {
                        cell.classList.remove('modified');
                    }
                };
                input.addEventListener('input', changeHandler);
                input.addEventListener('change', changeHandler);

                span.style.display = 'none';
                cell.appendChild(input);
            });

            // Warn before leaving page
            window.addEventListener('beforeunload', beforeUnloadHandler);
        }

        function beforeUnloadHandler(e) {
            if (isEditMode) {
                e.preventDefault();
                e.returnValue = '';
            }
        }

        function cancelEdit() {
            if (!confirm('Discard all changes?')) return;
            
            isEditMode = false;
            window.removeEventListener('beforeunload', beforeUnloadHandler);

            // Remove inputs, show spans
            document.querySelectorAll('.editable-cell').forEach(cell => {
                const input = cell.querySelector('.edit-input');
                const span = cell.querySelector('.view-mode');
                if (input) input.remove();
                if (span) span.style.display = 'inline';
                cell.classList.remove('modified');
            });

            // Show normal buttons, hide edit buttons
            normalButtons.forEach(el => el.style.display = 'inline-block');
            editButtons.forEach(el => el.style.display = 'none');
            editModeMsg.style.display = 'none';
        }

        function saveChanges() {
            const changes = [];
            
            // Collect all modified values
            document.querySelectorAll('.edit-input').forEach(input => {
                const fileId = input.dataset.fileId;
                const field = input.dataset.field;
                const newValue = input.value;
                const oldValue = originalData[fileId][field];
                
                if (newValue !== oldValue) {
                    changes.push({
                        file_id: fileId,
                        field: field,
                        value: newValue
                    });
                }
            });

            if (changes.length === 0) {
                alert('No changes detected');
                cancelEdit();
                return;
            }

            if (!confirm(`Save ${changes.length} change(s) to database?`)) return;

            // Prompt for password
            const password = prompt('Enter database password:');
            if (!password) {
                alert('Password required to save changes');
                return;
            }

            // Send to server
            fetch("{{ url_for('cart_items_update') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ changes: changes, password: password, db_table: '{{ db_table }}' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove beforeunload listener BEFORE reloading
                    isEditMode = false;
                    window.removeEventListener('beforeunload', beforeUnloadHandler);
                    
                    alert(`Successfully updated ${data.updated} item(s)`);
                    window.location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error saving changes: ' + error);
            });
        }

        function pruneSelected() {
            // Get all checked items
            const selectedCheckboxes = document.querySelectorAll('input[name="selected"]:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('No items selected');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            const count = selectedIds.length;

            if (!confirm(`WARNING: This will permanently delete ${count} item(s) from the database.\n\nThis action CANNOT be undone!\n\nAre you sure you want to continue?`)) {
                return;
            }

            // Prompt for password
            const password = prompt('Enter database password to confirm deletion:');
            if (!password) {
                alert('Password required to delete items');
                return;
            }

            // Send to server
            fetch("{{ url_for('cart_items_prune') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ file_ids: selectedIds, password: password, db_table: '{{ db_table }}' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully deleted ${data.deleted} item(s) from database`);
                    window.location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error deleting items: ' + error);
            });
        }

        // Context Menu functionality
        const contextMenu = document.getElementById('contextMenu');
        const applyToSelectedMenuItem = document.getElementById('applyToSelected');
        let contextMenuTarget = null;

        // Show context menu on right-click of editable fields (only in edit mode)
        document.addEventListener('contextmenu', function(e) {
            if (!isEditMode) return;
            
            const target = e.target;
            if (target.classList.contains('edit-input') || target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
                const cell = target.closest('.editable-cell');
                if (cell) {
                    e.preventDefault();
                    contextMenuTarget = target;
                    
                    // Position the context menu
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = e.pageX + 'px';
                    contextMenu.style.top = e.pageY + 'px';
                }
            }
        });

        // Hide context menu on click anywhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.context-menu')) {
                contextMenu.style.display = 'none';
            }
        });

        // Apply to Selected functionality
        if (applyToSelectedMenuItem) {
            applyToSelectedMenuItem.addEventListener('click', function() {
                if (!contextMenuTarget) return;
                
                const cell = contextMenuTarget.closest('.editable-cell');
                if (!cell) return;
                
                const field = cell.dataset.field;
                const value = contextMenuTarget.value;
                
                // Get all checked items
                const selectedCheckboxes = document.querySelectorAll('input[name="selected"]:checked');
                const selectedFileIds = new Set(Array.from(selectedCheckboxes).map(cb => cb.value));
                
                // Apply to selected cells in the same column
                const allCellsInColumn = document.querySelectorAll(`.editable-cell[data-field="${field}"]`);
                allCellsInColumn.forEach(targetCell => {
                    const fileId = targetCell.dataset.fileId;
                    // Only apply to selected items
                    if (selectedFileIds.has(fileId)) {
                        const input = targetCell.querySelector('.edit-input');
                        if (input && input !== contextMenuTarget) {
                            input.value = value;
                            
                            // Trigger the change detection
                            if (originalData[fileId] && value !== originalData[fileId][field]) {
                                targetCell.classList.add('modified');
                            } else {
                                targetCell.classList.remove('modified');
                            }
                        }
                    }
                });
                
                contextMenu.style.display = 'none';
            });
        }
    </script>
{% endblock %}